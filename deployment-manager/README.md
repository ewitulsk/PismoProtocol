# Deployment Manager

**⚠️ IMPORTANT WARNING ⚠️**

**This package's scripts (`npm run initalize` and `npm run copydata`) are designed to be executed ONLY as part of the main `deploycontracts.sh` script located in the root of the repository. They rely on the output of a fresh contract deployment (`contracts/deployment.json`) and perform critical one-time initialization and configuration steps. DO NOT run these scripts manually unless you are specifically following the `deploycontracts.sh` workflow.**

---

This directory contains scripts to manage the initialization and configuration propagation after deploying the smart contracts.

## Scripts

### `npm run initalize`

This script performs the crucial on-chain initialization steps required after the contracts are first published to the network.

**Functionality:**

1.  **Reads Deployment Output:** Parses the `contracts/deployment.json` file generated by the `sui client publish` command.
2.  **Connects to Sui:** Establishes a connection to the configured Sui network (e.g., 'testnet' as defined in `src/initalize.ts`).
3.  **Requires Private Key:** Uses the `SUI_PRIVATE_KEY` environment variable to sign transactions. Ensure this variable is set in your environment (e.g., via a `.env` file in the `deployment-manager` directory).
4.  **Extracts IDs:** Identifies the `Package ID`, `Global Object ID`, `Admin Cap ID`, and `Test Coin Treasury Cap ID` from the deployment output.
5.  **Performs On-Chain Initialization:** Executes a single transaction block containing the following operations:
    *   Mints an initial supply of `TEST_COIN` to the deployer address.
    *   Adds `TEST_COIN` as a supported Liquidity Pool (LP) type in the main contract, using placeholder price feed details.
    *   Initializes the LP Vault specifically for the `TEST_COIN` / `TEST_LP` pair.
    *   Initializes the main Program with placeholder configurations for collateral, position types, and leverage, again using placeholder price feed details.
6.  **Captures Initialization Details:** Extracts the `Program Object ID` created during initialization and the blockchain `checkpoint` number at which the initialization transaction was finalized.
7.  **Writes Output:** Saves the `Package ID`, `Global Object ID`, `Program Object ID`, `initializationCheckpoint`, and `network` to the `initialized_deployment.json` file in the `deployment-manager` directory.

**Environment Variables:**

*   `SUI_PRIVATE_KEY`: Your Sui private key (base64 encoded, potentially with `suiprivkey` prefix) used for signing the initialization transaction.

### `npm run copydata`

This script takes the information generated by the `initalize` script (`initialized_deployment.json`) and updates configuration files across other services in the monorepo.

**Functionality:**

1.  **Reads Initialization Data:** Loads the details from `initialized_deployment.json`.
2.  **Updates Backend Config:** Modifies `backend/config/backend_config.json` with the correct contract addresses (`packageId`, `globalObjectId`, `programObjectId`) and the appropriate Sui API URL based on the network.
3.  **Updates Frontend Env:** Modifies `frontend/.env` with the relevant `NEXT_PUBLIC_` variables for contract addresses and the Sui Explorer URL.
4.  **Updates Indexer Config:** Modifies `indexer/config/testnet.toml` (or potentially other network files in the future) with the `package_id`, the correct checkpoint URL (`remote_store_url`), and the `start_checkpoint`.

## Workflow Integration

As highlighted above, these scripts are integral parts of the `deploycontracts.sh` script:

1.  `deploycontracts.sh` first publishes the contracts, creating `contracts/deployment.json`.
2.  It then runs `npm run initalize` within the `deployment-manager` directory to perform the on-chain setup and create `initialized_deployment.json`.
3.  Finally, it runs `npm run copydata` to distribute the necessary configuration details to the backend, frontend, and indexer services. 